module.exports = function () {

  // Todo we can pass this through later
  var baseurl = '';

  function hasValue (x) {
    // empty helper for strings, objects, arrays
    if (typeof(x) === 'string' || typeof(x) === 'array') {
      return x.length > 0
    } else if (typeof(x) === 'object') {
      return Object.keys(x).length > 0
    } else {
      return false;
    }
  };


  function convert(memberData) {
    return memberData.map(function (page) {
      // page[0] is json
      // page[1] is adoc

      var data = JSON.parse(page[0].content);
      var tmp = page[1].content;
      
      // map structure generated by template.js
      // data.datapath = string
      // data.desc = string
      // data.constructors = []
      // data.methods = []
      // data.properties = []
      // data.settings = []
      // data.events = []
      // data.keywords = []
      // data.borrows = data.borrows || []
      // data.examples = data.examples || []


      // summary
      if (hasValue(data.summary)) {
        tmp += data.summary + '\n';
      }

      // borrows
      // untested snipped, no class extends data
      if (hasValue(data.borrows)) {
        tmp += '<a class="anchor" id="extends"></a>' + '\n'
        tmp += '<h2><a class="anchorable" href="#extends">Extends</a></h2>' + '\n'
        data.borrows.forEach(item => {
          tmp += '<a href="' + baseurl + '/api/' + item + '">' + item + '</a>' + '\n'
        });
      }

      // examples
      if (hasValue(data.examples)) {
        tmp += '<h2>Examples</h2>' + '\n';
        data.examples.forEach(example => {
          tmp += '<pre class="prettyprint"><code class="js" data-lang="js">' + example.content + '</code></pre>\n';
        });
      }

      // settings
      // untested snippet, no settings data
      if (hasValue(data.settings)) {
        tmp += '<a class="anchor" id="settings"></a>';
        tmp += '<h2><a class="anchorable" href="#settings">Settings</a></h2>';
        tmp += '<table class="settings">';
        tmp += '<thead>';
        tmp += '<tr>';
        tmp += '<th>name</th>';
        tmp += '<th>type</th>';
        tmp += '<th>summary</th>';
        tmp += '<th class="defined-by">defined by</th>';
        tmp += '</tr>';
        tmp += '</thead>';
        tmp += '<tbody>';

        data.settings.forEach(item => {
          tmp += '<tr>';
          tmp += '<td>' + item.name + '</td>';
          tmp += '<td>';
          if (item.dataTypes[0].includes('tinymce', 0)) {
            tmp += '<a href="' + baseurl + '/apis/' + item.dataTypes[0] + '"><span class="param-type">' + item.dataTypes[0] + '</span></a>';
          } else {
            tmp += '<span class="param-type">' + item.dataTypes[0] + '</span>';    
          }
          tmp += '</td>';
          tmp += '<td>' + item.desc + '</td>';
          tmp += '<td class="defined-by">';
          tmp += '<a href="' + baseurl + '/apis/' + item.definedBy + '">' + item.definedBy + '</a>';
          tmp += '</td>';
          tmp += '</tr>';
        })

        tmp += '</tbody>';
        tmp += '</table>\n';
      }

      // // properties
      // if (hasValue(data.properties)) {
      //   tmp += '<a class="anchor" id="properties"></a>';
      //   tmp += '<h2><a class="anchorable" href="#properties">Properties</a></h2>';
      //   tmp += '<table class="properties">';
      //   tmp += '<thead>';
      //   tmp += '<tr>';
      //   tmp += '<th>name</th>';
      //   tmp += '<th>type</th>';
      //   tmp += '<th>summary</th>';
      //   tmp += '<th class="defined-by">defined by</th>';
      //   tmp += '</tr>';
      //   tmp += '</thead>';
      //   tmp += '<tbody>';
      //   data.properties.forEach(item => {
      //     tmp += '<tr>';
      //     tmp += '<td>{{ item.name }}</td>';
      //     tmp += '<td>';
          
      //     if (item.dataTypes[0].includes('tinymce', 0)) {
      //       tmp += '<a href="' + baseurl + '/apis/' + item.dataTypes[0] + '"><span class="param-type">' + item.dataTypes[0] + '</span></a>';
      //     } else {
      //       tmp += '<span class="param-type">' + item.dataTypes[0] + '</span>';
      //     }
        
      //     tmp += '</td>';
      //     tmp += '<td>' + item.desc + '</td>';
      //     tmp += '<td class="defined-by">';
      //     tmp += '<a href="' + baseurl + '/apis/' + item.definedBy + '">' + item.definedBy + '</a>';
      //     tmp += '</td>';
      //     tmp += '</tr>';
      //   })
      //   tmp += '</tbody>';
      //   tmp += '</table>\n';
      // }

      // // constructors - basic summary
      // if (hasValue(data.constructors)) {
      //   tmp += '<a class="anchor" id="constructors"></a>';
      //   tmp += '<h2><a class="anchorable" href="#constructors">Constructors</a></h2>';
      //   tmp += '<table class="constructors">';
      //   tmp += '<thead>';
      //   tmp += '<tr>';
      //   tmp += '<th>name</th>';
      //   tmp += '<th>summary</th>';
      //   tmp += '<th class="defined-by">defined by</th>';
      //   tmp += '</tr>';
      //   tmp += '</thead>';
      //   tmp += '<tbody>';
      //   data.constructors.forEach(item => {
      //     tmp += '<tr>';
      //     tmp += '<td><a href="' + item.name + '">' + item.name + '()</a></td>';
      //     tmp += '<td>' + item.desc + '</td>';
      //     tmp += '<td class="defined-by">';
      //     tmp += '<a href="' + baseurl + '/apis/' + item.definedBy + '">' + item.definedBy + '</a>';
      //     tmp += '</td>';
      //     tmp += '</tr>';
      //   });
      //   tmp += '</tbody>';
      //   tmp += '</table>\n';
      // }

      // methods - basic summary
      if (hasValue(data.methods)) {
        tmp += '[[methods]]\n';
        tmp += '\n== ' + data.name + ' Reference\n';
        tmp += '[options="header"]\n'
        tmp += '|===\n'
        tmp += '|Name|Summary|Defined by\n'
        data.methods.forEach(item => {
          tmp += '|link:' + item.name + '[' + item.name + '()]|' + item.desc + '|link:' + baseurl + '/apis/' + item.definedBy + '[' + item.definedBy + ']\n';
        });
        tmp += '|===\n'
      }

      // // events - basic summary
      // if (hasValue(data.events)) {
      //   tmp += '<a class="anchor" id="events"></a>';
      //   tmp += '<h2><a class="anchorable" href="#events">Events</a></h2>';
      //   tmp += '<table class="events">';
      //   tmp += '<thead>';
      //   tmp += '<tr>';
      //   tmp += '<th>name</th>';
      //   tmp += '<th>summary</th>';
      //   tmp += '<th class="defined-by">defined by</th>';
      //   tmp += '</tr>';
      //   tmp += '</thead>';
      //   tmp += '<tbody>';
      //   data.events.forEach(item => {
      //     tmp += '<tr>';
      //     tmp += '<td><a href="' + item.name + '">' + item.name + '()</a></td>';
      //     tmp += '<td>' + item.desc + '</td>';
      //     tmp += '<td class="defined-by">';
      //     tmp += '<a href="' + baseurl + '/apis/' + item.definedBy + '">' + item.definedBy + '</a>';
      //     tmp += '</td>';
      //     tmp += '</tr>';
      //   });
      //   tmp += '</tbody>';
      //   tmp += '</table>\n';
      // }

      // // constructors 2 - enhanced detail
      // if (hasValue(data.constructors)) {
      //   tmp += '<h2>Constructors</h2>';
      //   data.constructors.forEach(constructor => {
      //     tmp += '<a class="anchor" id="' + constructor.name + '"></a>';
      //     tmp += '<h3><a class="anchorable" href="#' + constructor.name + '">' + constructor.name + '</a></h3>';
      //     tmp += '<div class="signature">' + constructor.signature + '</div>';
      //     tmp += '<p>constructor.desc</p>\n';
      //     if (hasValue(constructor.examples)) {
      //       tmp += '<h5>Examples</h5>';
      //       constructor.examples.forEach(example => {
      //         tmp += '<pre class="prettyprint"><code class="js" data-lang="js">' + example.content + '</code></pre>\n';
      //       })
      //     }
      //     if (hasValue(constructor.params)) {
      //       tmp += '<h5>Parameters</h5>';
      //       tmp += '<ul>';
      //       constructor.params.forEach(param => {
      //         tmp += '<li>';
      //         tmp += '<span class="param-name">' + param.name + '</span>';
      //         if (param.types[0].includes('tinymce', 0)) {
      //           tmp += '<a href="' + baseurl + '/apis/' + param.types[0] + '"><span class="param-type">' + param.types[0] + '</span></a>';
      //         } else {
      //           tmp += '<span class="param-type">' + param.types[0] + '</span>';    
      //         }
      //         tmp += '</li>';
      //       })
      //       tmp += '</ul>\n';
      //     }

      //     if (hasValue(constructor.return) && hasValue(constructor.return.types)) {
      //       // untested - no data
      //       tmp += '<h5>Return value</h5>';
      //       tmp += '<ul>';
      //       constructor.return.types.forEach(type => {
      //         tmp += '<li>';
      //         if (type.includes('tinymce', 0)) {
      //           tmp += '<a href="' + baseurl + '/apis/' + type + '"><span class="return-type">' + type + '</span></a>';
      //         } else {
      //           tmp += '<span class="return-type">' + type + '</span>';
      //         }
      //         tmp += ' - ' + constructor.return.desc 
      //         tmp += '</li>\n';
      //       });
      //       tmp += '</ul>\n';
      //     };
      //   });
      // }

      // methods 2 - enhanced details
      if (hasValue(data.methods)) {
        tmp += '\n== Methods\n';
        data.methods.forEach(method => {

          tmp += '[[' + method.name + ']]\n';
          tmp += '\n=== ' + method.name + '()\n';
          tmp += '[source, javascript]\n';
          tmp += '----\n';
          tmp += method.signature + '\n';
          tmp += '----\n';
          tmp += method.desc + '\n';
          
          if (hasValue(method.examples)) {
            tmp += '==== Examples\n';
            method.examples.forEach(example => {
              tmp += '[source, javascript]\n';
              tmp += '----\n';
              tmp += example.content + '\n';
              tmp += '----\n';
            });
          }
          if (hasValue(method.params)) {
            tmp += '\n==== Parameters\n';
            method.params.forEach(param => {
              tmp += '\n* `+' + param.name;
              if (param.types[0].includes('tinymce', 0)) {
                tmp += ' link:' + baseurl + '/apis/' + param.types[0] + '[' + param.types[0] + ']';
              } else {
                tmp += ' (' + param.types[0] + ')+`';
              }
              tmp += ' - ' + param.desc + '\n';
            })
          }
        
          if (hasValue(method.return) && hasValue(method.return.types)) {
            tmp += '\n==== Return value\n';
            method.return.types.forEach(type => {
              tmp += '\n* `+';
              if (type.includes('tinymce', 0)) {
                tmp += 'link:' + baseurl + '/apis/' + type + '[' + type + ']';
              } else {
                tmp += '(' + type + ')+`';
              }
              tmp += ' - ' + method.return.desc  + '\n';
            });
          }

          tmp += "\n'''\n";
        });
      }


      // // events 2 - enhanced details
      // if (hasValue(data.events)) {
      //   tmp += '<h2>Events</h2>';
      //   data.events.forEach(event => {
      //     tmp += '<a class="anchor" id="' + event.name + '"></a>';
      //     tmp += '<h3><a class="anchorable" href="#' + event.name + '">' + event.name + '</a></h3>';
      //     tmp += '<p>' + event.desc + '</p>';
      //   });
      //   if (hasValue(method.params)) {
      //     tmp += '<h5>Parameters</h5>';
      //     tmp += '<ul>';
      //     method.params.forEach(param => {
      //       tmp += '<li>';
      //       tmp += '<span class="param-name">' + param.name + '</span>';
      //       if (param.types[0].includes('tinymce', 0)) {
      //         tmp += '<a href="' + baseurl + '/apis/' + param.types[0] + '"><span class="return-type">' + param.types[0] + '</span></a>';
      //       } else {
      //         tmp += '<span class="return-type">' + param.types[0] + '</span>';
      //       }
      //       tmp += ' - ' + param.desc 
      //       tmp += '</li>\n';
      //     })
      //     tmp += '</ul>\n';
      //   }
      // }

      // return the applied antora page mutation
      page[1].content = tmp
      return page;
    })
  }

  return {
    convert: convert
  }
}();